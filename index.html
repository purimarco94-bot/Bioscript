<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioDiary Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #27ae60; --accent: #8e44ad; --premium: #f1c40f; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .page { display: none; padding: 20px 15px 100px 15px; min-height: 100vh; box-sizing: border-box; }
        .active-page { display: block; }
        .card { background: var(--white); border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        
        /* Premium Badge */
        .badge-premium { background: var(--premium); color: #000; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 5px; margin-left: 5px; }

        /* Bottom Nav (4 voci ora) */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { border: none; background: none; color: #888; font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* UI Elements */
        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999; border: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 10px; font-size: 15px; box-sizing: border-box; }
        
        /* Recipe Styles */
        .recipe-item { border-left: 4px solid var(--premium); padding-left: 10px; margin-bottom: 15px; }
        .ingredient-tag { display: inline-block; background: #eee; padding: 4px 8px; border-radius: 5px; font-size: 12px; margin: 2px; }
    </style>
</head>
<body>

    <button class="fab" id="fabBtn" onclick="toggleModal()">+</button>

    <div id="page-diario" class="page active-page">
        <h2>Report <span id="modeTitle">Giorno</span></h2>
        <div class="card">
            <input type="date" id="dateSelector" onchange="renderApp()">
            <div style="height: 180px;"><canvas id="chartMain"></canvas></div>
        </div>
        <div id="foodList"></div>
    </div>

    <div id="page-premium" class="page">
        <h2>Smart Recipes <span class="badge-premium">PREMIUM</span></h2>
        <div class="card">
            <h3>üõí La tua Dispensa</h3>
            <input type="text" id="ingIn" placeholder="Aggiungi ingrediente (es: Uova)">
            <button class="btn" style="background:var(--accent)" onclick="addIngredient()">Aggiungi Ingredienti</button>
            <div id="dispensaList" style="margin-top:10px;"></div>
        </div>
        <div id="recipeResults">
            <button class="btn" style="background:var(--premium); color:black;" onclick="suggestRecipes()">‚ú® Suggerisci Ricette AI</button>
            <div id="recipesContainer" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="page-scan" class="page">
        <h2>Scanner AI</h2>
        <div class="card" style="text-align:center;">
            <div style="background:#000; height:300px; border-radius:15px; display:flex; align-items:center; justify-content:center; color:white;">
                <video id="video" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline></video>
            </div>
            <button class="btn" onclick="startCamera()">Attiva Fotocamera</button>
            <button class="btn" style="background:var(--accent); margin-top:10px;" onclick="alert('Analisi AI...')">Analizza Piatto</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h2>Profilo & Peso</h2>
        <div class="card">
            <input type="number" id="p-weight" placeholder="Peso (kg)">
            <button class="btn" onclick="saveWeight()">Registra Peso</button>
            <div style="height: 150px; margin-top:15px;"><canvas id="chartWeight"></canvas></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('diario', this)">üìä<br>Diario</button>
        <button class="nav-item" onclick="switchPage('premium', this)">‚≠ê<br>Ricette</button>
        <button class="nav-item" onclick="switchPage('scan', this)">üì∏<br>Scanner</button>
        <button class="nav-item" onclick="switchPage('profile', this)">üë§<br>Profilo</button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('bioElite_V5_db')) || [];
        let dispensa = JSON.parse(localStorage.getItem('bioElite_V5_dispensa')) || [];
        let weights = JSON.parse(localStorage.getItem('bioElite_V5_weights')) || [];
        let chartM = null, chartW = null;

        // --- GESTIONE DISPENSA & RICETTE ---
        function addIngredient() {
            const ing = document.getElementById('ingIn').value;
            if(ing) {
                dispensa.push(ing);
                localStorage.setItem('bioElite_V5_dispensa', JSON.stringify(dispensa));
                document.getElementById('ingIn').value = '';
                renderDispensa();
            }
        }

        function renderDispensa() {
            const container = document.getElementById('dispensaList');
            container.innerHTML = dispensa.map(i => `<span class="ingredient-tag">${i}</span>`).join('');
        }

        function suggestRecipes() {
            const container = document.getElementById('recipesContainer');
            if(dispensa.length === 0) { alert("Aggiungi ingredienti alla dispensa!"); return; }
            
            container.innerHTML = "‚åõ L'AI sta cucinando per te...";
            
            // Simulazione Database Ricette Premium
            const mockRecipes = [
                { nome: "Omelette Proteica", kcal: 250, ing: ["Uova", "Formaggio"] },
                { nome: "Insalata Greca", kcal: 180, ing: ["Pomodoro", "Feta", "Olive"] },
                { nome: "Pasta al Pomodoro", kcal: 450, ing: ["Pasta", "Pomodoro"] }
            ];

            // Filtro basato su ingredienti presenti
            const trovate = mockRecipes.filter(r => r.ing.some(i => dispensa.includes(i)));

            setTimeout(() => {
                container.innerHTML = trovate.length > 0 ? "" : "Nessuna ricetta esatta, ma ecco un'idea:";
                const lista = trovate.length > 0 ? trovate : [mockRecipes[0]];
                
                lista.forEach(r => {
                    container.innerHTML += `
                        <div class="card recipe-item">
                            <h4>${r.nome}</h4>
                            <p><b>${r.kcal} kcal</b></p>
                            <button class="btn" style="padding:8px; font-size:12px;" onclick="addRecipeToDiary('${r.nome}', ${r.kcal})">Aggiungi al Diario</button>
                        </div>
                    `;
                });
            }, 1000);
        }

        function addRecipeToDiary(nome, cal) {
            const date = document.getElementById('dateSelector').value || new Date().toISOString().split('T')[0];
            db.push({ id: Date.now(), nome: "Ricetta: " + nome, cal: cal, cat: "Pranzo", data: date });
            localStorage.setItem('bioElite_V5_db', JSON.stringify(db));
            alert("Ricetta aggiunta al diario!");
            switchPage('diario', document.querySelectorAll('.nav-item')[0]);
        }

        // --- CORE FUNCTIONS (Ripristinate) ---
        function switchPage(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-'+id).classList.add('active-page');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('fabBtn').style.display = (id === 'diario') ? 'flex' : 'none';
            if(id === 'diario') renderApp();
            if(id === 'premium') renderDispensa();
        }

        async function startCamera() {
            const v = document.getElementById('video');
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                v.srcObject = s;
            } catch(e) { alert("Camera Error"); }
        }

        function renderApp() {
            const date = document.getElementById('dateSelector').value || new Date().toISOString().split('T')[0];
            const oggi = db.filter(p => p.data === date);
            const ctx = document.getElementById('chartMain').getContext('2d');
            
            let stats = { Colazione:0, Pranzo:0, Cena:0, Snack:0 };
            oggi.forEach(p => stats[p.cat] += p.cal);

            if(chartM) chartM.destroy();
            chartM = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }] },
                options: { maintainAspectRatio: false }
            });
        }

        document.getElementById('dateSelector').valueAsDate = new Date();
        renderApp();
    </script>
</body>
</html>
