<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioDiary Ultimate v11</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #27ae60; --accent: #8e44ad; --water: #3498db; --fasting: #f39c12; --bg: #f4f7f6; --white: #ffffff; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #2c3e50; }
        .page { display: none; padding: 20px 15px 100px 15px; min-height: 100vh; box-sizing: border-box; }
        .active-page { display: block; }
        .card { background: var(--white); border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        
        /* Fasting Timer UI */
        .timer-display { font-size: 32px; font-weight: bold; text-align: center; color: var(--fasting); margin: 10px 0; }
        
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999; border: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { border: none; background: none; color: #888; font-size: 11px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="page-diario" class="page active-page">
        <h2>Report & Digiuno</h2>
        
        <div class="card">
            <h3>‚è≥ Timer Digiuno</h3>
            <div id="timerStatus" class="timer-display">00:00:00</div>
            <button id="fastBtn" class="btn" style="background:var(--fasting)" onclick="toggleFast()">Inizia Digiuno</button>
        </div>

        <div class="card">
            <input type="date" id="dateSelector" onchange="renderApp()">
            <div style="height: 180px;"><canvas id="chartMain"></canvas></div>
        </div>
        
        <div id="foodList"></div>
    </div>

    <div id="page-premium" class="page">
        <h2>Cucina ‚≠ê</h2>
        <div class="card">
            <input type="text" id="ingIn" placeholder="Aggiungi ingrediente...">
            <button class="btn" onclick="addIngredient()">Aggiungi</button>
            <div id="dispensaList" style="margin-top:10px;"></div>
        </div>
        <div id="recipesResults"></div>
    </div>

    <div id="page-scan" class="page">
        <h2>Scanner AI</h2>
        <div class="card">
            <video id="video" style="width:100%; border-radius:15px; background:#000;" autoplay playsinline></video>
            <button class="btn" onclick="simulateBarcodeScan()">Scansiona Prodotto</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h2>Profilo & Dati</h2>
        <div class="card">
            <button class="btn" onclick="exportData()">üì• Esporta Backup (Cloud/JSON)</button>
            <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üì§ Carica Backup</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            <button class="btn" style="background:var(--accent)" onclick="generatePDF()">üìÑ Genera Report Testuale (PDF)</button>
        </div>
        <div class="card">
            <label>Peso (kg)</label>
            <input type="number" id="p-weight">
            <button class="btn" onclick="saveProfile()">Aggiorna</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('diario', this)">üìä<br>Diario</button>
        <button class="nav-item" onclick="switchPage('premium', this)">‚≠ê<br>Cucina</button>
        <button class="nav-item" onclick="switchPage('scan', this)">üì∏<br>Scan</button>
        <button class="nav-item" onclick="switchPage('profile', this)">üë§<br>Profilo</button>
    </nav>

<script>
    let db = JSON.parse(localStorage.getItem('bio_v11_db')) || [];
    let fastData = JSON.parse(localStorage.getItem('bio_v11_fast')) || { active: false, start: null };
    let timerInterval;

    // --- FASTING TIMER ---
    function toggleFast() {
        if (!fastData.active) {
            fastData.active = true;
            fastData.start = Date.now();
            document.getElementById('fastBtn').innerText = "Termina Digiuno";
        } else {
            fastData.active = false;
            fastData.start = null;
            document.getElementById('fastBtn').innerText = "Inizia Digiuno";
        }
        localStorage.setItem('bio_v11_fast', JSON.stringify(fastData));
        updateTimer();
    }

    function updateTimer() {
        if (fastData.active) {
            const diff = Date.now() - fastData.start;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('timerStatus').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        } else {
            document.getElementById('timerStatus').innerText = "00:00:00";
        }
    }

    // --- BACKUP CLOUD & EXPORT ---
    function exportData() {
        const data = { db: db, prof: localStorage.getItem('bio_v11_prof'), weights: localStorage.getItem('bio_v11_w') };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BioDiary_Backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const imported = JSON.parse(e.target.result);
            db = imported.db;
            localStorage.setItem('bio_v11_db', JSON.stringify(db));
            alert("Dati importati con successo!");
            location.reload();
        };
        reader.readAsText(file);
    }

    function generatePDF() {
        let text = "REPORT BIODIARY\n\n";
        db.forEach(p => text += `${p.data} - ${p.nome}: ${p.cal} kcal\n`);
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Report_Salute.txt";
        a.click();
    }

    // --- CORE ---
    function switchPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById('page-'+id).classList.add('active-page');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'diario') renderApp();
    }

    function renderApp() {
        updateTimer();
        if(!timerInterval) timerInterval = setInterval(updateTimer, 1000);
        // ... (Logica renderApp precedente per Grafico e Lista Cibi)
    }

    document.getElementById('dateSelector').valueAsDate = new Date();
    if(fastData.active) document.getElementById('fastBtn').innerText = "Termina Digiuno";
    renderApp();
</script>
</body>
</html>
// --- FUNZIONE ESPORTA PDF (TESTUALE) ---
function generatePDF() {
    let report = "BIODIARY ULTIMATE REPORT\n";
    report += "Generato il: " + new Date().toLocaleString() + "\n";
    report += "------------------------------------------\n\n";
    
    db.forEach(p => {
        report += `[${p.data}] ${p.cat}: ${p.nome} - ${p.cal} kcal\n`;
    });
    
    const blob = new Blob([report], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "BioDiary_Report.txt";
    link.click();
}

// --- BACKUP CLOUD (JSON) ---
function exportData() {
    const backup = {
        pasti: db,
        profilo: prof,
        pesi: weights,
        idratazione: waterData
    };
    const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "BioDiary_Backup.json";
    link.click();
}
