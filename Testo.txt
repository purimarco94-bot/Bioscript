<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioDiary AI Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #27ae60; --accent: #8e44ad; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .page { display: none; padding: 20px; padding-bottom: 100px; min-height: 100vh; box-sizing: border-box; }
        .active-page { display: block; }
        .card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 999; border: none; }
        
        /* Search Suggestions */
        .suggestions-list { background: white; border-radius: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; display: none; margin-top: -10px; margin-bottom: 10px; }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; border-radius: 20px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; }
        .nav-item { border: none; background: none; color: #888; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 10px; }
        .loading-spinner { font-size: 12px; color: var(--accent); display: none; }
    </style>
</head>
<body>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3>üçé Ricerca Cibo Online</h3>
            <input type="text" id="nameIn" placeholder="Cerca prodotto (es: Nutella, Pasta...)" oninput="searchOnlineFood()">
            <div id="loading" class="loading-spinner">Ricerca nel database...</div>
            <div id="suggestions" class="suggestions-list"></div>
            
            <input type="number" id="calIn" placeholder="Calorie (kcal per 100g)">
            <select id="catIn">
                <option value="Colazione">Colazione</option>
                <option value="Pranzo">Pranzo</option>
                <option value="Cena">Cena</option>
                <option value="Snack">Snack</option>
            </select>
            <button class="btn" onclick="salvaPasto()">Aggiungi al Diario</button>
            <button onclick="toggleModal()" style="background:none; border:none; color:red; width:100%; margin-top:15px;">Chiudi</button>
        </div>
    </div>

    <button class="fab" id="fabBtn" onclick="toggleModal()">+</button>

    <div id="page-diario" class="page active-page">
        <h2>Il mio Diario</h2>
        <div class="card">
            <input type="date" id="dateSelector" onchange="renderApp()">
            <div style="display:flex; justify-content:space-around; text-align:center;">
                <div><small>Totale</small><br><b id="totalCal" style="color:var(--primary); font-size:20px;">0</b></div>
                <div><small>Obiettivo</small><br><b id="targetVal" style="font-size:20px;">2000</b></div>
            </div>
            <div style="height: 180px; margin-top:20px;"><canvas id="dailyChart"></canvas></div>
        </div>
        <div id="foodList"></div>
    </div>

    <div id="page-scan" class="page">
        <h2>üì∏ AI Vision Scanner</h2>
        <div class="card" style="text-align: center;">
            <div id="camera-container" style="background:#000; height:350px; border-radius:20px; overflow:hidden; position:relative;">
                <video id="video" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline></video>
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); border:2px dashed white; width:200px; height:200px; pointer-events:none;"></div>
            </div>
            <p id="scan-status" style="font-size:14px; margin-top:10px;">Inquadra un prodotto per l'analisi</p>
            <button class="btn" style="background:var(--accent)" onclick="captureAndAnalyze()">Analizza con AI</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h2>Profilo</h2>
        <div class="card">
            <input type="number" id="u-weight" placeholder="Peso (kg)">
            <input type="number" id="u-height" placeholder="Altezza (cm)">
            <input type="number" id="u-age" placeholder="Et√†">
            <button class="btn" onclick="salvaProfilo()">Aggiorna Dati</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('diario', this)">üìÖ<br>Diario</button>
        <button class="nav-item" onclick="switchPage('scan', this)">üì∏<br>AI Scan</button>
        <button class="nav-item" onclick="switchPage('profile', this)">üë§<br>Profilo</button>
    </nav>

<script>
    let db = JSON.parse(localStorage.getItem('bioDiaryStore')) || [];
    let user = JSON.parse(localStorage.getItem('bioUser')) || { target: 2000 };
    let chart = null;

    // --- RICERCA ONLINE (Open Food Facts) ---
    async function searchOnlineFood() {
        const query = document.getElementById('nameIn').value;
        const suggestions = document.getElementById('suggestions');
        const loading = document.getElementById('loading');
        
        if (query.length < 3) { suggestions.style.display = 'none'; return; }
        
        loading.style.display = 'block';
        try {
            const response = await fetch(`https://it.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1&page_size=5`);
            const data = await response.json();
            
            suggestions.innerHTML = "";
            data.products.forEach(prod => {
                const kcal = prod.nutriments['energy-kcal_100g'] || 0;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<b>${prod.product_name}</b><br><small>${kcal} kcal/100g - ${prod.brands || ''}</small>`;
                div.onclick = () => {
                    document.getElementById('nameIn').value = prod.product_name;
                    document.getElementById('calIn').value = Math.round(kcal);
                    suggestions.style.display = 'none';
                };
                suggestions.appendChild(div);
            });
            suggestions.style.display = 'block';
        } catch (e) { console.error("Errore database", e); }
        loading.style.display = 'none';
    }

    // --- AI VISION (Simulata per Browser) ---
    async function initCamera() {
        const video = document.getElementById('video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
        } catch (e) { alert("Fotocamera non disponibile"); }
    }

    function captureAndAnalyze() {
        const status = document.getElementById('scan-status');
        status.innerText = "üöÄ Analisi AI in corso...";
        
        // Qui si invierebbe il frame della camera a un'API come OpenAI Vision
        setTimeout(() => {
            status.innerHTML = "‚úÖ <b>Mela rilevata!</b> (52 kcal)";
            if(confirm("Ho rilevato una Mela. La aggiungo al diario?")) {
                db.push({ id: Date.now(), nome: "Mela (AI Scan)", cal: 52, cat: "Snack", data: new Date().toISOString().split('T')[0] });
                localStorage.setItem('bioDiaryStore', JSON.stringify(db));
                switchPage('diario', document.querySelectorAll('.nav-item')[0]);
            }
        }, 2000);
    }

    // --- LOGICA APP ---
    function switchPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('page-'+id).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'scan') initCamera();
        if(id === 'diario') renderApp();
    }

    function toggleModal() {
        const m = document.getElementById('addModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    function salvaPasto() {
        const nome = document.getElementById('nameIn').value;
        const cal = parseInt(document.getElementById('calIn').value);
        if(nome && cal) {
            db.push({ id: Date.now(), nome, cal, cat: document.getElementById('catIn').value, data: document.getElementById('dateSelector').value });
            localStorage.setItem('bioDiaryStore', JSON.stringify(db));
            toggleModal(); renderApp();
        }
    }

    function renderApp() {
        const date = document.getElementById('dateSelector').value || new Date().toISOString().split('T')[0];
        const oggi = db.filter(p => p.data === date);
        let tot = 0; let stats = { Colazione:0, Pranzo:0, Cena:0, Snack:0 };
        const list = document.getElementById('foodList');
        list.innerHTML = "";
        
        oggi.forEach(p => {
            tot += p.cal; stats[p.cat] += p.cal;
            list.innerHTML += `<div class="card" style="margin-bottom:8px; padding:10px; display:flex; justify-content:space-between;">
                <span>${p.nome}</span> <b>${p.cal} kcal</b>
            </div>`;
        });
        document.getElementById('totalCal').innerText = tot;
        document.getElementById('targetVal').innerText = user.target;

        const ctx = document.getElementById('dailyChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    document.getElementById('dateSelector').valueAsDate = new Date();
    renderApp();
</script>
</body>
</html>
